name: Poll Strava API

on:
    schedule:
      - cron: '0 7 * * *'
      - cron: '0 14 * * *'
      - cron: '0 19 * * *'
      - cron: '0 2 * * *'
      - cron: '20 7 * * *'
      - cron: '20 14 * * *'
      - cron: '20 19 * * *'
      - cron: '20 2 * * *'
      - cron: '40 7 * * *'
      - cron: '40 14 * * *'
      - cron: '40 19 * * *'
      - cron: '40 2 * * *'
    workflow_dispatch:
      inputs:
        batch:
          description: Batch number (1, 2, 3, or empty for all)
          required: false

jobs:
    poll:
      runs-on: ubuntu-latest
      steps:
        - name: Determine batch from schedule
          id: batch
          run: |
            # Manual trigger with explicit batch
            if [ "${{ github.event.inputs.batch }}" != "" ]; then
              echo "batch=${{ github.event.inputs.batch }}" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Determine batch from which cron schedule triggered this run
            # (Don't rely on execution time - GitHub delays crons by 10-30 min)
            SCHEDULE="${{ github.event.schedule }}"
            case "$SCHEDULE" in
              "0 7 * * *"|"0 14 * * *"|"0 19 * * *"|"0 2 * * *")
                echo "batch=1" >> $GITHUB_OUTPUT
                ;;
              "20 7 * * *"|"20 14 * * *"|"20 19 * * *"|"20 2 * * *")
                echo "batch=2" >> $GITHUB_OUTPUT
                ;;
              "40 7 * * *"|"40 14 * * *"|"40 19 * * *"|"40 2 * * *")
                echo "batch=3" >> $GITHUB_OUTPUT
                ;;
              *)
                # Fallback for manual runs without batch specified
                echo "batch=" >> $GITHUB_OUTPUT
                ;;
            esac

        - name: Poll Strava API
          run: |
            BATCH="${{ steps.batch.outputs.batch }}"
            if [ -n "$BATCH" ]; then
              echo "Polling batch $BATCH"
              curl -X POST "https://www.burrito.run/api/cron/poll-strava?batch=$BATCH" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
                --fail --show-error
            else
              echo "Polling all segments"
              curl -X POST "https://www.burrito.run/api/cron/poll-strava" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
                --fail --show-error
            fi
