name: Poll Strava API
on:
    schedule:
      # Batch 1 (most active segments) - runs at :00
      # Times in UTC: 7:00, 14:00, 19:00, 2:00 = 12am, 7am, 12pm, 7pm MST
      - cron: '0 7 * * *'
      - cron: '0 14 * * *'
      - cron: '0 19 * * *'
      - cron: '0 2 * * *'
      # Batch 2 (medium activity) - runs at :20
      - cron: '20 7 * * *'
      - cron: '20 14 * * *'
      - cron: '20 19 * * *'
      - cron: '20 2 * * *'
      # Batch 3 (lower activity) - runs at :40
      - cron: '40 7 * * *'
      - cron: '40 14 * * *'
      - cron: '40 19 * * *'
      - cron: '40 2 * * *'
    workflow_dispatch:
      inputs:
        batch:
          description: 'Batch number (1, 2, 3, or empty for all)'
          required: false
          default: ''
jobs:
    poll:
      runs-on: ubuntu-latest
      steps:
        - name: Determine batch from schedule
          id: batch
          run: |
            MINUTE=$(date -u +%M)
            if [ "${{ github.event.inputs.batch }}" != "" ]; then
              echo "batch=${{ github.event.inputs.batch }}" >> $GITHUB_OUTPUT
            elif [ "$MINUTE" -lt "10" ]; then
              echo "batch=1" >> $GITHUB_OUTPUT
            elif [ "$MINUTE" -lt "30" ]; then
              echo "batch=2" >> $GITHUB_OUTPUT
            elif [ "$MINUTE" -lt "50" ]; then
              echo "batch=3" >> $GITHUB_OUTPUT
            else
              echo "batch=" >> $GITHUB_OUTPUT
            fi

        - name: Poll Strava API
          run: |
            BATCH="${{ steps.batch.outputs.batch }}"
            if [ -n "$BATCH" ]; then
              echo "Polling batch $BATCH"
              curl -X POST "https://www.burrito.run/api/cron/poll-strava?batch=$BATCH" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
                --fail --show-error
            else
              echo "Polling all segments"
              curl -X POST "https://www.burrito.run/api/cron/poll-strava" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
                --fail --show-error
            fi
